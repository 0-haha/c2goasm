# c2goasm: C to Go Assembly 

## Introduction

This is a tool to convert assembly as generated by a C/C++ compiler into Golang assembly. It is meant to be used in combination with [asm2plan9s](https://github.com/minio/asm2plan9s) in order to automatically generate pure Go wrappers for C/C++ code (that may for instance take advantage of compiler intrinsics).



Mode of operation:
```
$ c2goasm /path/to/c-project/build/SimdAvx2Detection.cpp.s SimdAvx2Detection_amd64.s
$ asm2plan9s SimdAvx2Detection_amd64.s
```

Optionally you can nicely format the code using [asmfmt](https://github.com/klauspost/asmfmt):
```
$ asmfmt SimdAvx2Detection_amd64.s
```

This project has been developed as part of developing a Go wrapper around [Simd](https://github.com/ermig1979/Simd). However it should also work with other project and libraries.

## Invocation

```
$ c2goasm /path/to/c-project/build/SomeGreatCode.cpp.s SomeGreatCode_amd64.s
```

## Example

Here is a simple example.

C source using intrinsics
```
void MultiplyAndAdd(float* arg1, float* arg2, float* arg3, float* result) {
    __m256 vec1 = _mm256_load_ps(arg1);
    __m256 vec2 = _mm256_load_ps(arg2);
    __m256 vec3 = _mm256_load_ps(arg3);
    __m256 res  = _mm256_fmadd_ps(vec1, vec2, vec3);
    Store<true>((__m256i*)(result), res);
}
```

Generated assembly
```
__ZN4Simd4Avx214MultiplyAndAddEPfS1_S1_S1_: ## @_ZN4Simd4Avx214MultiplyAndAddEPfS1_S1_S1_
## BB#0:
        push          rbp
        mov           rbp, rsp
        vmovups       ymm0, ymmword ptr [rdi]
        vmovups       ymm1, ymmword ptr [rsi]
        vfmadd213ps   ymm1, ymm0, ymmword ptr [rdx]
        vmovups       ymmword ptr [rcx], ymm1
        pop           rbp
        vzeroupper
        ret
```

Go assembly
```
```

Go code
```
```

## Internals

- Map function arguments from Golang calling convention into C calling convention
- Setup an (aligned) stack for the C code
- Get constants from Go assembly table to handle `rip`-based loads (PIC = position independent code) 

Caveats
- Arguments need to be 64-bit size (either a value or a pointer) 
- No `call` statements (i.e. inline your C code)

## Generate assembly from C/C++

See list of assembly targets
```
$ make help | grep "\.s"
```

See actual command
```
$ make -n  SimdAvx2BgraToGray.s
```

Additional arguments to aid in assembly generation
```
```

## Tested compilers

- clang on OSX
